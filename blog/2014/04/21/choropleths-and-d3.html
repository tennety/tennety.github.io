<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset='UTF-8'>
  <meta content='' name='description'>
  <meta content='' name='copyright'>
  <link href='/humans.txt' rel='author' type='text/plain'>
  <meta content='width=device-width, initial-scale=1.0' name='viewport'>
  <meta content='true' name='HandheldFriendly'>
  <meta content='320' name='MobileOptimized'>
  <meta content='yes' name='apple-mobile-web-app-capable'>
  <meta content='black-translucent' name='apple-mobile-web-app-status-bar-style'>
  <meta content='on' http-equiv='cleartype'>
  <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
  <title>Choropleths and D3.js</title>
  <link href="/stylesheets/application.css" media="screen" rel="stylesheet" type="text/css" />
  
  <!-- IE backporting -->
  <!--[if lt IE 9]>
  <script src="/javascripts/html5.js" type="text/javascript"></script>
  <![endif]-->
  
</head>
<body>
  <div class='sticky'>
    <nav class='top-bar home-border'>
      <ul class='title-area'>
        <li class='name'>
          <h1>
            <a href="/">Chandu Tennety</a>
          </h1>
        </li>
        <li class='toggle-topbar menu-icon'>
          <a href=''>
            <span></span>
          </a>
        </li>
      </ul>
      <section class='top-bar-section'>
        <ul class='left'>
          <li>
            <a href='/blog'>Blog</a>
          </li>
          <li>
            <a href='/resume.html'>Resume</a>
          </li>
          <li>
            <a href='https://github.com/tennety' target='_blank'>
              <i class='icon-github-alt'></i>
            </a>
          </li>
          <li>
            <a href='https://twitter.com/tennety' target='_blank'>
              <i class='icon-twitter'></i>
            </a>
          </li>
          <li>
            <a href='mailto:chandu.tennety+blog@gmail.com' target='_blank'>
              <i class='icon-envelope-alt'></i>
            </a>
          </li>
        </ul>
      </section>
    </nav>
  </div>
  <div class='row'>
    <div class='small-12 columns'>
      <div class='row'>
        <article class='small-9 columns'>
          <h1>
            Choropleths and D3.js
          </h1>
          <p>Choropleths are a great way to get a really clear depiction of how a statistic
          varies by location. I'd like to share my experience from a project that we're
          not quite ready to announce yet.</p>
          
          <p>In our case, the statistic in question is the frequency of
          sightings for a given species of bird. The idea is to be able to see which
          areas of the country reflect a greater frequency month to month in order to get
          a feel for when and how the bird migrates.</p>
          
          <p>To have the map dynamically change with new data values, we need the map to be
          composed of DOM elements whose styles can be manipulated based on changing
          data. D3.js gives us ways to do exactly that, and more. The approach consists
          of three components:</p>
          
          <ol>
            <li>Generate an SVG map based on standard geographical data</li>
            <li>Associate the map elements with the bird frequency data</li>
            <li>Map the frequency numbers to visual styles</li>
          </ol>
          
          <p>The following subsections describe each of these components in detail.</p>
          
          <h2 id="geojsonhttpgeojsonorg-and-topojsonhttpsgithubcommbostocktopojson"><a href="http://geojson.org/">GeoJSON</a> and <a href="https://github.com/mbostock/topojson">TopoJSON</a></h2>
          
          <p>GeoJSON is a JSON standard that represents geographical data. For our purposes,
          we can think of it as a grouping of objects in terms of their geometry.
          Countries, states, counties, rivers and roads may all be represented in terms
          of points and lines in a coordinate system. Easy, right?</p>
          
          <p>Taking that a little further, TopoJSON is an extension to GeoJSON that has a
          notion of topology and shared geometry. So, for instance, if two polygons have
          a shared edge, GeoJSON will use two lines for it, but TopoJSON will use only
          one. For large geometries, TopoJSON can effect a dramatic decrease in file size.</p>
          
          <p>To get your hands dirty with some GeoJSON, head <a href="http://geojson.io">to geojson.io</a>. For
          an introduction to how TopoJSON works, I highly recommend
          <a href="http://bost.ocks.org/mike/map/">the author's example</a>. Another invaluable resource
          is the <a href="https://github.com/mbostock/us-atlas">US Atlas</a> project, which comes with a
          handy Makefile to generate TopoJSON for almost any kind of US map you want.</p>
          
          <p><a href="http://twitter.com/mbostock">Mike Bostock</a>, who created TopoJSON, is also the
          author of D3. Coincidence? No, not at all, because D3.js is built to consume
          both GeoJSON and TopoJSON to create SVG path elements in the browser. In just
          <a href="http://bl.ocks.org/mbostock/4136647">a few lines of code</a>, we can load up
          TopoJSON from the server and display a beautiful county map of the United
          States in the browser.</p>
          
          <h2 id="d3js-data-binding">D3.js Data Binding</h2>
          
          <p>D3's most powerful feature is its data binding, which allows us to attach
          arbitrary data to DOM elements, and then manipulate any number of their
          properties as a function of that data. I recommend <a href="http://alignedleft.com/tutorials">Scott Murray's
          tutorials</a> for anyone looking to get a better
          understanding of this concept.</p>
          
          <p>In our case, it's only a matter of being able to uniquely identify any county,
          and have a mechanism to look up its bird frequency when needed. We do this by
          ensuring that the generated TopoJSON for the map contains the state and county
          name for each county as part of its bound data. Then, as we retrieve new data
          for county-wise bird sightings, we can look up the frequency using this info.</p>
          
          <p>For instance, say Whatcom County in Washington reported 1 sighting of the
          American Bittern in Feb 2013. Once we can determine which SVG element
          represents that county, we can render its color proportional to 1 bird
          sighting. To do this with vanilla JS on a scale of over 2700 counties across
          the US seems prohibitive, but D3's selection API makes it easy and fast. As
          a special touch, the duration of an element's transition from one color to
          another is also a function of the data, so we can gently animate the colors
          as we move from month to month. Time for some code:</p>
          
          <pre class="highlight clojure"><table><tbody><tr><td class="gutter gl"><div class="lineno">1</div><div class="lineno">2</div><div class="lineno">3</div><div class="lineno">4</div><div class="lineno">5</div><div class="lineno">6</div><div class="lineno">7</div><div class="lineno">8</div><div class="lineno">9</div><div class="lineno">10</div><div class="lineno">11</div><div class="lineno">12</div><div class="lineno">13</div><div class="lineno">14</div><div class="lineno">15</div></td><td class="code"><span class="w">    </span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">freq-duration</span><span class="w"> </span><span class="p">[</span><span class="n">data</span><span class="p">]</span><span class="w">
                </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">(</span><span class="nf">freq-for-county</span><span class="w"> </span><span class="n">data</span><span class="p">))</span><span class="w"> </span><span class="mi">200</span><span class="p">))</span><span class="w">
          
              </span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">freq-color</span><span class="w"> </span><span class="p">[</span><span class="n">data</span><span class="p">]</span><span class="w">
                </span><span class="p">(</span><span class="nf">color</span><span class="w"> </span><span class="p">(</span><span class="nf">freq-for-county</span><span class="w"> </span><span class="n">data</span><span class="p">)))</span><span class="w">
          
              </span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">update-counties</span><span class="w"> </span><span class="p">[</span><span class="n">results</span><span class="p">]</span><span class="w">
                </span><span class="p">(</span><span class="nf">populate-freqs</span><span class="w"> </span><span class="n">results</span><span class="p">)</span><span class="w">
                </span><span class="p">(</span><span class="w"> </span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">js/d3</span><span class="w">
                     </span><span class="p">(</span><span class="nf">.selectAll</span><span class="w"> </span><span class="s">&quot;path.county&quot;</span><span class="p">)</span><span class="w">
                     </span><span class="p">(</span><span class="nf">.transition</span><span class="p">)</span><span class="w">
                     </span><span class="p">(</span><span class="nf">.duration</span><span class="w"> </span><span class="n">freq-duration</span><span class="p">)</span><span class="w">
                     </span><span class="p">(</span><span class="nf">.style</span><span class="w"> </span><span class="s">&quot;fill&quot;</span><span class="w"> </span><span class="n">freq-color</span><span class="p">)</span><span class="w">
                     </span><span class="p">(</span><span class="nf">.style</span><span class="w"> </span><span class="s">&quot;stroke&quot;</span><span class="w"> </span><span class="n">freq-color</span><span class="p">)))</span><span class="w">
          </span></td></tr></tbody></table></pre>
          <p>In the above code snippet, <code>update-counties</code> gets called with the response from
          the server every time the month (or the species of bird selected) changes.
          <code>populate-freqs</code> updates the frequency lookup table for each county name. Then
          D3 is used to select all the county elements (<code>path.county</code>), and specify that
          each of those should transition to the new <code>freq-color</code> over a duration of
          <code>freq-duration</code>.  Both <code>freq-color</code> and <code>freq-duration</code> take a single argument,
          <code>data</code>, which is simply the data bound to each county element, consisting of
          (among other things) the state and county name.<code>freq-for-county</code> is the
          frequency lookup function. Pretty concise for all the work it's doing!</p>
          
          <p>If you notice, <code>freq-color</code> uses a <code>color</code> function to return a color from a
          frequency value. This function is a special D3.js function called a <a href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#quantile-scales">quantile
          scale</a>.
          Its primary purpose is to take an input value, and return a transformed value
          in a specified range. In the case of <code>color</code>, it takes a number, and maps it in
          a range of 9 colors based on where it falls between 0 and 5. The 9 colors come
          from <a href="http://colorbrewer2.org/">ColorBrewer</a>, which is an awesome project by
          Cynthia Brewer to provide color-blind-friendly color options for cartographers.</p>
          
          <h2 id="stay-tuned">Stay Tuned</h2>
          
          <p>And so we have the basic building blocks for our migration mapper. In the next
          couple of weeks, we're going to introduce you to the application, and we'll talk
          some more about how Clojure, ClojureScript and Datomic are powerful tools
          for building interactive applications.</p>
          <ul class='read_next'>
            <li><a href="/blog/2013/09/04/unexamined-privilege.html">&laquo; Unexamined Privilege</a></li>
            <li><a href="/blog/2014/07/18/flickr-cljs.html">Using the Flickr API with ClojureScript &raquo;</a></li>
          </ul>
          <div id='disqus_thread'>
            <script type='text/javascript'>
              var disqus_shortname = 'tennety';
              (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
            <noscript>
              Please enable JavaScript to view the
              <a href="http://disqus.com/?ref_noscript">comments powered by Disqus</a>
            </noscript>
            <a class='dsq-brlink' href='http://disqus.com'>
              <span class='logo-disqus'>Disqus</span>
            </a>
          </div>
        </article>
        <aside class='small-3 columns'>
          <ul class='credit'>
            <li><a class="tiny button secondary round" href="/blog/tags/tech.html">tech</a></li>
            <li><a class="tiny button secondary round" href="/blog/tags/javascript.html">JavaScript</a></li>
            <li><a class="tiny button secondary round" href="/blog/tags/d3.html">d3</a></li>
            <li><a class="tiny button secondary round" href="/blog/tags/mapping.html">mapping</a></li>
            <li><a class="tiny button secondary round" href="/blog/tags/data-viz.html">data-viz</a></li>
          </ul>
        </aside>
      </div>
    </div>
  </div>
  <footer class='row'>
    <!--[if lt IE 8]>
    <div id="ie-warning-overlay">
    <div id="ie-warning">
    <h1>Did you know that your copy of Internet Explorer is out of date?</h1>
    <p>
    To get the best possible experience using our website, we recommend that you upgrade to the latest version or use another web browser.
    Any of the following will provide a superior experience, not only on this site, but across the web.
    </p>
    <p>Just click one of the icons below to get to the download page.</p>
    <ul>
    <li>
    <a href="http://microsoft.com/ie">
    <%= image_tag 'browser_ie.gif', :alt => "Download Internet Explorer" %>
    <p>Internet Explorer 8+</p>
    </a>
    </li>
    <li>
    <a href="http://mozilla.org/firefox">
    <%= image_tag 'browser_firefox.gif', :alt => "Download Firefox" %>
    <p>Firefox</p>
    </a>
    </li>
    <li>
    <a href="http://google.com/chrome">
    <%= image_tag 'browser_chrome.gif', :alt => "Download Chrome" %>
    <p>Google Chrome</p>
    </a>
    </li>
    <li>
    <a href="http://apple.com/safari">
    <%= image_tag 'browser_safari.gif', :alt => "Download Safari" %>
    <p>Safari</p>
    </a>
    </li>
    <li>
    <a href="http://opera.com">
    <%= image_tag 'browser_opera.gif', :alt => "Download Opera" %>
    <p>Opera</p>
    </a>
    </li>
    </ul>
    </div>
    </div>
    <![endif]-->
  </footer>
  <!-- jQuery -->
  <script src='//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
  <script>
    window.jQuery || document.write('<script src="/jquery.js"><\/script>');
  </script>
  <!-- Javascript -->
  <script src="/javascripts/application.js" type="text/javascript"></script>
  
  <script type='text/javascript'>
    $(document).ready(function () {
    imgSizer.collate();
    
    });
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-46441071-1', 'tennety.github.io');
    ga('send', 'pageview');
  </script>
</body>


